<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Outil d’assistance au trading</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root {
            --bg-main: #060b10;
            --bg-card: #0e151c;
            --bg-card-soft: #111a22;
            --accent: #f0b90b;
            --accent-soft: rgba(240,185,11,0.1);
            --text-main: #e5edf5;
            --text-muted: #8f9fb3;
            --border-subtle: #1f2a36;
            --danger: #ff4d4f;
            --success: #22c55e;
            --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --radius-lg: 14px;
            --radius-pill: 999px;
            --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.6);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 24px;
            font-family: var(--font-main);
            background: radial-gradient(circle at 0 0, rgba(240,185,11,0.08), transparent 55%),
                        radial-gradient(circle at 100% 100%, rgba(56,189,248,0.05), transparent 55%),
                        var(--bg-main);
            color: var(--text-main);
        }

        h1 {
            font-size: 1.5rem;
            margin: 0 0 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h1 span.logo-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 12px rgba(240,185,11,0.8);
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
            gap: 20px;
        }

        @media (max-width: 900px) {
            body {
                padding: 16px;
            }
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: linear-gradient(145deg, var(--bg-card), #050810);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-soft);
            padding: 16px 18px 18px;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 0 0, rgba(240,185,11,0.08), transparent 55%);
            opacity: 0.4;
            pointer-events: none;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .card-badge {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 3px 10px;
            border-radius: var(--radius-pill);
            border: 1px solid rgba(240,185,11,0.35);
            background: rgba(240,185,11,0.12);
            color: var(--accent);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .card-badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--accent);
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .price-main {
            display: flex;
            flex-direction: column;
        }

        .symbol-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .price-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .price-change {
            font-size: 0.8rem;
        }

        .price-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            border: 1px solid var(--border-subtle);
            background: rgba(15,23,42,0.8);
            color: var(--text-main);
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: var(--radius-pill);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.12s ease, border-color 0.12s ease, transform 0.06s ease;
            min-height: 30px;
        }

        .btn:hover {
            background: rgba(15,23,42,1);
            border-color: rgba(148,163,184,0.7);
            transform: translateY(-0.5px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #f0b90b, #f5d24a);
            border-color: #eab308;
            color: #111827;
            font-weight: 600;
        }

        .btn-primary:hover {
            filter: brightness(1.04);
        }

        .btn-ghost {
            background: rgba(15,23,42,0.85);
        }

        .btn-toggle {
            border: 1px solid var(--border-subtle);
            background: rgba(15,23,42,0.8);
            position: relative;
        }

        .btn-toggle.active {
            border-color: var(--accent);
            background: var(--accent-soft);
            color: var(--accent);
        }

        .btn-toggle-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--accent);
        }

        .btn-toggle-dot.off {
            background: var(--border-subtle);
        }

        .small-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
            position: relative;
            z-index: 1;
        }

        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-dot.online {
            background: var(--success);
            box-shadow: 0 0 8px rgba(34,197,94,0.8);
        }

        .status-dot.offline {
            background: var(--danger);
        }

        .field-group {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px 14px;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 640px) {
            .field-group {
                grid-template-columns: 1fr;
            }
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .field-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .field-label span.main {
            color: var(--text-main);
        }

        .field-label small {
            font-size: 0.7rem;
        }

        .field-input-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .input, .select {
            width: 100%;
            padding: 6px 9px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: rgba(15,23,42,0.9);
            color: var(--text-main);
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.14s ease, box-shadow 0.1s ease, background 0.1s ease;
        }

        .input:focus,
        .select:focus {
            border-color: rgba(240,185,11,0.85);
            box-shadow: 0 0 0 1px rgba(240,185,11,0.35);
            background: #020617;
        }

        .input[readonly] {
            opacity: 0.85;
        }

        .input:disabled,
        .select:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        .side-toggle {
            display: inline-flex;
            padding: 2px;
            border-radius: var(--radius-pill);
            background: rgba(15,23,42,0.9);
            border: 1px solid var(--border-subtle);
        }

        .side-toggle button {
            flex: 1;
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: var(--radius-pill);
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: background 0.12s ease, color 0.12s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .side-toggle button.active {
            background: rgba(55,65,81,0.9);
            color: var(--text-main);
        }

        .side-toggle button.long.active {
            background: rgba(34,197,94,0.16);
            color: var(--success);
        }

        .side-toggle button.short.active {
            background: rgba(248,113,113,0.16);
            color: #f97373;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .checkbox-row input {
            accent-color: var(--accent);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 3px 9px;
            border-radius: var(--radius-pill);
            border: 1px solid rgba(148,163,184,0.45);
            font-size: 0.7rem;
            color: var(--text-muted);
            gap: 6px;
        }

        .chip-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: var(--accent);
            opacity: 0.8;
        }

        .output-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px 14px;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 640px) {
            .output-grid {
                grid-template-columns: 1fr;
            }
        }

        .metric {
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(15,23,42,0.9);
            border: 1px solid rgba(15,23,42,1);
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-height: 58px;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .metric-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .metric-value.positive {
            color: var(--success);
        }

        .metric-value.negative {
            color: #f97373;
        }

        .metric-sub {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .output-footer {
            margin-top: 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .pill {
            padding: 4px 9px;
            border-radius: var(--radius-pill);
            border: 1px dashed var(--border-subtle);
            font-size: 0.72rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .pill span.key {
            color: var(--text-main);
        }

        .section-divider {
            height: 1px;
            background: radial-gradient(circle at 50% 0, rgba(148,163,184,0.4), transparent 60%);
            margin: 10px 0 12px;
            opacity: 0.6;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <h1>
        <span class="logo-dot"></span>
        Outil d’assistance au calcul de position
    </h1>
    <div class="subtitle">
        Calculez en temps réel le résultat d’une position (long/short), avec effet de levier, frais de transaction et frais horaires, à partir du prix courant de la crypto choisie.
    </div>

    <div class="layout">
        <!-- Colonne gauche : prix et paramètres globaux -->
        <div class="left-column">
            <!-- Carte prix temps réel -->
            <div class="card" id="priceCard">
                <div class="card-header">
                    <div class="card-title">Prix temps réel (Binance)</div>
                    <div class="card-badge">
                        <span class="card-badge-dot"></span>
                        Flux marché
                    </div>
                </div>

                <div class="price-row">
                    <div class="price-main">
                        <div class="symbol-label">
                            Pair
                            <select id="symbolSelect" class="select" style="width:auto;display:inline-block;">
                                <option value="INJUSDT" selected>INJ / USDT</option>
                                <option value="BTCUSDT">BTC / USDT</option>
                                <option value="ETHUSDT">ETH / USDT</option>
                                <option value="BNBUSDT">BNB / USDT</option>
                            </select>
                        </div>
                        <div class="price-value" id="currentPrice">–</div>
                    </div>
                    <div class="price-actions">
                        <button class="btn btn-ghost" id="refreshPriceBtn">
                            ↻ Actualiser
                        </button>
                    </div>
                </div>

                <div class="status-row">
                    <div>
                        <span class="status-dot online" id="priceStatusDot"></span>
                        <span id="priceStatusText">En écoute du flux (toutes les 5 s)…</span>
                    </div>
                    <div>
                        <span class="small-label" id="lastUpdateText">Dernière mise à jour : –</span>
                    </div>
                </div>
            </div>

            <!-- Carte paramètres de position -->
            <div class="card" style="margin-top:16px;">
                <div class="card-header">
                    <div class="card-title">Paramètres de position</div>
                    <div class="chip">
                        <span class="chip-dot"></span> Simulation locale
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="field-group">
                    <!-- Taille de wallet -->
                    <div class="field">
                        <div class="field-label">
                            <span class="main">Wallet initial</span>
                            <small>Par défaut : 100</small>
                        </div>
                        <input type="number" step="0.01" id="walletInput" class="input" value="100" />
                    </div>

                    <!-- Direction long/short -->
                    <div class="field">
                        <div class="field-label">
                            <span class="main">Direction</span>
                            <small>Long / Short</small>
                        </div>
                        <div class="side-toggle" id="sideToggle">
                            <button type="button" class="long active" data-side="long">
                                ▲ Long
                            </button>
                            <button type="button" class="short" data-side="short">
                                ▼ Short
                            </button>
                        </div>
                    </div>

                    <!-- Effet de levier -->
                    <div class="field">
                        <div class="field-label">
                            <span class="main">Effet de levier</span>
                            <small>Activé par défaut</small>
                        </div>
                        <div class="field-input-wrapper">
                            <input type="number" step="0.1" min="1" id="leverageInput" class="input" value="5" />
                            <span style="font-size:0.8rem;color:var(--text-muted);">x</span>
                        </div>
                        <div class="checkbox-row" style="margin-top:4px;">
                            <input type="checkbox" id="leverageEnabled" checked />
                            <label for="leverageEnabled">Utiliser l’effet de levier</label>
                        </div>
                    </div>

                    <!-- Frais de transaction -->
                    <div class="field">
                        <div class="field-label">
                            <span class="main">Frais de transaction</span>
                            <small>Par défaut : 0,10 %</small>
                        </div>
                        <div class="field-input-wrapper">
                            <input type="number" step="0.01" min="0" id="txFeeInput" class="input" value="0.10" />
                            <span style="font-size:0.8rem;color:var(--text-muted);">%</span>
                        </div>
                        <div class="small-label">Appliqués à l’entrée et à la sortie (2×).</div>
                    </div>

                    <!-- Frais horaires -->
                    <div class="field">
                        <div class="field-label">
                            <span class="main">Frais horaires (levier)</span>
                            <small>Par défaut : 0,01 % / h</small>
                        </div>
                        <div class="field-input-wrapper">
                            <input type="number" step="0.001" min="0" id="hourlyFeeInput" class="input" value="0.01" />
                            <span style="font-size:0.8rem;color:var(--text-muted);">%</span>
                        </div>
                        <div class="small-label">Ne s’applique que si le levier est activé.</div>
                    </div>

                    <!-- Durée en heures -->
                    <div class="field">
                        <div class="field-label">
                            <span class="main">Durée d’exposition</span>
                            <small>Heures</small>
                        </div>
                        <input type="number" step="0.1" min="0" id="hoursInput" class="input" value="1" />
                        <div class="small-label">Utilisé uniquement pour le calcul des frais horaires.</div>
                    </div>

                    <!-- Prix d'entrée -->
                    <div class="field">
                        <div class="field-label">
                            <span class="main">Prix d’entrée</span>
                            <small>Copie du prix actuel possible</small>
                        </div>
                        <div class="field-input-wrapper">
                            <input type="number" step="0.0001" min="0" id="entryPriceInput" class="input" />
                            <button class="btn btn-ghost" type="button" id="copyEntryFromMarketBtn">
                                Copier prix actuel
                            </button>
                        </div>
                    </div>

                    <!-- Mode de sortie -->
                    <div class="field">
                        <div class="field-label">
                            <span class="main">Mode de sortie</span>
                            <small>Prix ou % de gain</small>
                        </div>
                        <select id="exitModeSelect" class="select">
                            <option value="price">Prix de sortie</option>
                            <option value="percent">Gain de sortie en %</option>
                        </select>
                    </div>

                    <!-- Prix de sortie -->
                    <div class="field" id="exitPriceField">
                        <div class="field-label">
                            <span class="main">Prix de sortie</span>
                            <small>Possibilité de lier au prix actuel</small>
                        </div>
                        <div class="field-input-wrapper">
                            <input type="number" step="0.0001" min="0" id="exitPriceInput" class="input" />
                            <button class="btn btn-toggle" type="button" id="linkExitToMarketBtn">
                                <span class="btn-toggle-dot off"></span>
                                Lier au prix actuel
                            </button>
                        </div>
                        <div class="small-label">
                            Lorsqu’activé, le prix de sortie suit le prix temps réel.
                        </div>
                    </div>

                    <!-- Gain de sortie en % -->
                    <div class="field hidden" id="exitPercentField">
                        <div class="field-label">
                            <span class="main">Gain de sortie (en %)</span>
                            <small>Par rapport au prix d’entrée</small>
                        </div>
                        <div class="field-input-wrapper">
                            <input type="number" step="0.1" id="exitPercentInput" class="input" value="2" />
                            <span style="font-size:0.8rem;color:var(--text-muted);">%</span>
                        </div>
                        <div class="small-label">
                            Le prix cible est calculé automatiquement (différent pour un long et un short).
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne droite : résumé et résultats -->
        <div class="right-column">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Résumé des résultats</div>
                    <button class="btn btn-primary" id="recalculateBtn" type="button">
                        Recalculer
                    </button>
                </div>

                <div class="section-divider"></div>

                <div class="output-grid">
                    <!-- Nouveau wallet -->
                    <div class="metric">
                        <div class="metric-label">Nouveau wallet estimé</div>
                        <div class="metric-value" id="newWalletValue">–</div>
                        <div class="metric-sub" id="newWalletSub">Après profits et frais.</div>
                    </div>

                    <!-- Gain / perte absolu -->
                    <div class="metric">
                        <div class="metric-label">Résultat net (monnaie)</div>
                        <div class="metric-value" id="profitAbsolute">–</div>
                        <div class="metric-sub" id="profitAbsoluteSub">Inclut tous les frais simulés.</div>
                    </div>

                    <!-- Gain / perte en % -->
                    <div class="metric">
                        <div class="metric-label">Résultat net (%) sur le wallet</div>
                        <div class="metric-value" id="profitPercent">–</div>
                        <div class="metric-sub" id="profitPercentSub">Par rapport au wallet initial.</div>
                    </div>

                    <!-- Total des frais -->
                    <div class="metric">
                        <div class="metric-label">Frais totaux (absolus)</div>
                        <div class="metric-value" id="feesAbsolute">–</div>
                        <div class="metric-sub" id="feesAbsoluteSub">Transactions + effet de levier.</div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="output-footer">
                    <div class="pill" id="effectiveExitPricePill">
                        <span class="key">Prix de sortie utilisé :</span>
                        <span id="effectiveExitPriceText">–</span>
                    </div>
                    <div class="pill" id="targetPricePill">
                        <span class="key">Prix cible (mode %)</span>
                        <span id="targetPriceText">–</span>
                    </div>
                    <div class="pill">
                        <span class="key">Montant réellement exposé :</span>
                        <span id="investedAmountText">–</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const symbolSelect = document.getElementById('symbolSelect');
            const currentPriceEl = document.getElementById('currentPrice');
            const refreshPriceBtn = document.getElementById('refreshPriceBtn');
            const priceStatusDot = document.getElementById('priceStatusDot');
            const priceStatusText = document.getElementById('priceStatusText');
            const lastUpdateText = document.getElementById('lastUpdateText');

            const walletInput = document.getElementById('walletInput');
            const sideToggle = document.getElementById('sideToggle');
            const leverageInput = document.getElementById('leverageInput');
            const leverageEnabledCheckbox = document.getElementById('leverageEnabled');
            const txFeeInput = document.getElementById('txFeeInput');
            const hourlyFeeInput = document.getElementById('hourlyFeeInput');
            const hoursInput = document.getElementById('hoursInput');
            const entryPriceInput = document.getElementById('entryPriceInput');
            const copyEntryFromMarketBtn = document.getElementById('copyEntryFromMarketBtn');
            const exitModeSelect = document.getElementById('exitModeSelect');
            const exitPriceField = document.getElementById('exitPriceField');
            const exitPriceInput = document.getElementById('exitPriceInput');
            const linkExitToMarketBtn = document.getElementById('linkExitToMarketBtn');
            const exitPercentField = document.getElementById('exitPercentField');
            const exitPercentInput = document.getElementById('exitPercentInput');

            const recalculateBtn = document.getElementById('recalculateBtn');
            const newWalletValueEl = document.getElementById('newWalletValue');
            const newWalletSubEl = document.getElementById('newWalletSub');
            const profitAbsoluteEl = document.getElementById('profitAbsolute');
            const profitAbsoluteSubEl = document.getElementById('profitAbsoluteSub');
            const profitPercentEl = document.getElementById('profitPercent');
            const profitPercentSubEl = document.getElementById('profitPercentSub');
            const feesAbsoluteEl = document.getElementById('feesAbsolute');
            const feesAbsoluteSubEl = document.getElementById('feesAbsoluteSub');
            const effectiveExitPricePill = document.getElementById('effectiveExitPricePill');
            const effectiveExitPriceText = document.getElementById('effectiveExitPriceText');
            const targetPricePill = document.getElementById('targetPricePill');
            const targetPriceText = document.getElementById('targetPriceText');
            const investedAmountText = document.getElementById('investedAmountText');

            let currentPrice = null;
            let lastPrice = null;
            let priceIntervalId = null;
            let linkExitToMarket = false;
            let currentSide = 'long';

            function formatNumber(value, decimals) {
                if (!isFinite(value)) return '–';
                const d = typeof decimals === 'number' ? decimals : 2;
                return Number(value).toLocaleString('fr-FR', {
                    minimumFractionDigits: d,
                    maximumFractionDigits: d
                });
            }

            function setStatusOnline() {
                if (priceStatusDot) {
                    priceStatusDot.classList.remove('offline');
                    priceStatusDot.classList.add('online');
                }
                if (priceStatusText) {
                    priceStatusText.textContent = 'Flux actif (toutes les 5 s)…';
                }
            }

            function setStatusError() {
                if (priceStatusDot) {
                    priceStatusDot.classList.remove('online');
                    priceStatusDot.classList.add('offline');
                }
                if (priceStatusText) {
                    priceStatusText.textContent = 'Erreur API Binance (voir console).';
                }
            }

            async function fetchPrice() {
                const symbol = symbolSelect.value || 'INJUSDT';
                try {
                    const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=' + symbol);
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();
                    lastPrice = currentPrice;
                    currentPrice = parseFloat(data.price);

                    if (!isFinite(currentPrice)) return;

                    currentPriceEl.textContent = formatNumber(currentPrice, 4);

                    if (lastPrice && currentPrice) {
                        const diff = currentPrice - lastPrice;
                        const pct = (diff / lastPrice) * 100;
                        // Optional: could display diff if needed
                    }

                    if (linkExitToMarket && exitModeSelect.value === 'price') {
                        exitPriceInput.value = currentPrice.toFixed(4);
                    }

                    if (entryPriceInput.value === '') {
                        entryPriceInput.value = currentPrice.toFixed(4);
                    }

                    const now = new Date();
                    if (lastUpdateText) {
                        lastUpdateText.textContent = 'Dernière mise à jour : ' +
                            now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    }

                    setStatusOnline();
                    recalculate();
                } catch (err) {
                    console.error('Erreur lors de la récupération du prix Binance:', err);
                    setStatusError();
                }
            }

            function startPriceInterval() {
                if (priceIntervalId) {
                    clearInterval(priceIntervalId);
                }
                priceIntervalId = setInterval(fetchPrice, 5000);
            }

            function updateExitModeUI() {
                const mode = exitModeSelect.value;
                if (mode === 'price') {
                    exitPriceField.classList.remove('hidden');
                    exitPercentField.classList.add('hidden');
                    targetPricePill.style.opacity = 0.5;
                } else {
                    exitPriceField.classList.add('hidden');
                    exitPercentField.classList.remove('hidden');
                    targetPricePill.style.opacity = 1;
                }
                recalculate();
            }

            function updateLeverageUI() {
                const enabled = leverageEnabledCheckbox.checked;
                leverageInput.disabled = !enabled;
                hourlyFeeInput.disabled = !enabled;
                hoursInput.disabled = !enabled;
                recalculate();
            }

            function updateSide(side) {
                currentSide = side === 'short' ? 'short' : 'long';
                const buttons = sideToggle.querySelectorAll('button[data-side]');
                buttons.forEach(btn => {
                    if (btn.getAttribute('data-side') === currentSide) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                recalculate();
            }

            function toggleLinkExit() {
                linkExitToMarket = !linkExitToMarket;
                const dot = linkExitToMarketBtn.querySelector('.btn-toggle-dot');
                if (linkExitToMarket) {
                    linkExitToMarketBtn.classList.add('active');
                    if (dot) dot.classList.remove('off');
                    if (currentPrice != null && exitModeSelect.value === 'price') {
                        exitPriceInput.value = currentPrice.toFixed(4);
                    }
                } else {
                    linkExitToMarketBtn.classList.remove('active');
                    if (dot) dot.classList.add('off');
                }
                recalculate();
            }

            function copyEntryFromMarket() {
                if (currentPrice != null) {
                    entryPriceInput.value = currentPrice.toFixed(4);
                    recalculate();
                }
            }

            function recalculate() {
                const wallet = parseFloat(walletInput.value.replace(',', '.')) || 0;
                const leverageEnabled = leverageEnabledCheckbox.checked;
                let leverage = parseFloat(leverageInput.value.replace(',', '.')) || 1;
                if (!leverageEnabled) leverage = 1;
                if (leverage < 1) leverage = 1;

                const txFeeRate = (parseFloat(txFeeInput.value.replace(',', '.')) || 0) / 100;
                const hourlyFeeRate = (parseFloat(hourlyFeeInput.value.replace(',', '.')) || 0) / 100;
                const hours = leverageEnabled ? (parseFloat(hoursInput.value.replace(',', '.')) || 0) : 0;

                const entryPrice = parseFloat(entryPriceInput.value.replace(',', '.')) || 0;

                const mode = exitModeSelect.value;
                let exitPrice = 0;
                let targetPriceForPercentMode = null;

                if (mode === 'price') {
                    exitPrice = parseFloat(exitPriceInput.value.replace(',', '.')) || 0;
                } else {
                    const pct = parseFloat(exitPercentInput.value.replace(',', '.')) || 0;
                    if (entryPrice > 0) {
                        if (currentSide === 'long') {
                            exitPrice = entryPrice * (1 + pct / 100);
                        } else {
                            exitPrice = entryPrice * (1 - pct / 100);
                        }
                        targetPriceForPercentMode = exitPrice;
                    }
                }

                const invested = wallet * leverage;
                let grossProfit = 0;
                let netProfit = 0;
                let totalFees = 0;

                if (entryPrice > 0 && exitPrice > 0 && invested > 0) {
                    const diffRatio = (exitPrice - entryPrice) / entryPrice;
                    const sideSign = currentSide === 'long' ? 1 : -1;
                    grossProfit = diffRatio * invested * sideSign;

                    const txFees = invested * txFeeRate * 2;
                    const hourlyFees = leverageEnabled ? invested * hourlyFeeRate * hours : 0;
                    totalFees = txFees + hourlyFees;

                    netProfit = grossProfit - totalFees;
                }

                const newWallet = wallet + netProfit;
                const pctGain = wallet !== 0 ? (netProfit / wallet) * 100 : 0;

                const profitPositive = netProfit > 0;
                const profitNegative = netProfit < 0;

                newWalletValueEl.textContent = wallet > 0 ? formatNumber(newWallet, 2) : '–';
                newWalletSubEl.textContent = wallet > 0
                    ? 'Wallet initial : ' + formatNumber(wallet, 2)
                    : 'Renseignez un wallet initial pour la simulation.';

                profitAbsoluteEl.textContent = netProfit === 0 && wallet === 0
                    ? '–'
                    : (netProfit >= 0 ? '+' : '') + formatNumber(netProfit, 2);
                profitAbsoluteEl.classList.remove('positive', 'negative');
                if (profitPositive) profitAbsoluteEl.classList.add('positive');
                if (profitNegative) profitAbsoluteEl.classList.add('negative');
                profitAbsoluteSubEl.textContent = 'Résultat net après déduction de tous les frais.';

                profitPercentEl.textContent = wallet > 0
                    ? ((pctGain >= 0 ? '+' : '') + formatNumber(pctGain, 2) + ' %')
                    : '–';
                profitPercentEl.classList.remove('positive', 'negative');
                if (wallet > 0 && pctGain > 0) profitPercentEl.classList.add('positive');
                if (wallet > 0 && pctGain < 0) profitPercentEl.classList.add('negative');
                profitPercentSubEl.textContent = wallet > 0
                    ? 'Variation relative au wallet initial.'
                    : 'Renseignez un wallet initial pour obtenir un pourcentage.';

                feesAbsoluteEl.textContent = totalFees > 0 ? formatNumber(totalFees, 2) : '0,00';
                feesAbsoluteSubEl.textContent = 'Transactions : ' + formatNumber(invested * txFeeRate * 2, 2) +
                    ' | Levier : ' + formatNumber(leverageEnabled ? invested * hourlyFeeRate * hours : 0, 2);

                effectiveExitPriceText.textContent = exitPrice > 0 ? formatNumber(exitPrice, 4) : '–';
                investedAmountText.textContent = invested > 0 ? formatNumber(invested, 2) : '–';

                if (mode === 'percent' && targetPriceForPercentMode != null) {
                    targetPriceText.textContent = formatNumber(targetPriceForPercentMode, 4);
                } else {
                    targetPriceText.textContent = '–';
                }
            }

            symbolSelect.addEventListener('change', () => {
                fetchPrice();
                startPriceInterval();
            });

            refreshPriceBtn.addEventListener('click', fetchPrice);

            if (sideToggle) {
                sideToggle.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-side]');
                    if (!btn) return;
                    const side = btn.getAttribute('data-side');
                    updateSide(side);
                });
            }

            leverageEnabledCheckbox.addEventListener('change', updateLeverageUI);

            [walletInput, leverageInput, txFeeInput, hourlyFeeInput, hoursInput,
             entryPriceInput, exitPriceInput, exitPercentInput].forEach(el => {
                el.addEventListener('input', recalculate);
            });

            exitModeSelect.addEventListener('change', () => {
                linkExitToMarket = false;
                linkExitToMarketBtn.classList.remove('active');
                const dot = linkExitToMarketBtn.querySelector('.btn-toggle-dot');
                if (dot) dot.classList.add('off');
                updateExitModeUI();
            });

            linkExitToMarketBtn.addEventListener('click', () => {
                if (exitModeSelect.value !== 'price') return;
                toggleLinkExit();
            });

            copyEntryFromMarketBtn.addEventListener('click', copyEntryFromMarket);

            recalculateBtn.addEventListener('click', recalculate);

            updateLeverageUI();
            updateExitModeUI();
            updateSide('long');

            fetchPrice();
            startPriceInterval();
        })();
    </script>
</body>
</html>
